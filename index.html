<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBD Clinical & PBS Prescribing Guide</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f172a;
            --primary-light: #f8fafc;
            --primary-border: #e2e8f0;
            --secondary: #2563eb;
            --secondary-light: #eff6ff;
            --accent: #0ea5e9;
            --text-dark: #1e293b;
            --text-muted: #475569;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            
            --success: #10b981;
            --success-light: #dcfce7;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --streamlined: #8b5cf6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-dark); line-height: 1.6; -webkit-font-smoothing: antialiased; }

        /* --- HEADER & CONTEXT TOGGLE --- */
        header { background: linear-gradient(135deg, var(--primary), #1e3a8a); color: white; padding: 2.5rem 5% 4.5rem 5%; text-align: center; }
        header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; letter-spacing: -0.02em; }
        header p { font-size: 1.1rem; font-weight: 300; opacity: 0.9; max-width: 650px; margin: 0 auto 1.5rem auto; }

        .context-toggle-wrapper { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .context-toggle { background: rgba(255, 255, 255, 0.1); border-radius: 99px; padding: 0.3rem; display: inline-flex; border: 1px solid rgba(255,255,255,0.2); }
        .context-btn {
            background: transparent; border: none; color: rgba(255,255,255,0.7); font-family: inherit; font-size: 0.95rem; font-weight: 600;
            padding: 0.6rem 1.5rem; border-radius: 99px; cursor: pointer; transition: all 0.2s;
        }
        .context-btn:hover { color: white; }
        .context-btn.active { background: white; color: var(--primary); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }

        /* --- MAIN CONTROLS --- */
        .main-controls { max-width: 1200px; margin: -2.5rem auto 2rem auto; background: white; padding: 1.5rem; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem; position: relative; z-index: 10; }
        @media(max-width: 768px) { .main-controls { grid-template-columns: 1fr; } }
        
        .form-control { width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--primary-border); border-radius: 8px; font-family: inherit; font-size: 0.95rem; outline: none; transition: all 0.2s; background-color: var(--primary-light); }
        .form-control:focus { border-color: var(--secondary); background-color: white; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        /* --- GRID & CARDS --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem 3rem 1rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 1.5rem; }
        .card { background: var(--bg-card); border: 1px solid var(--primary-border); border-radius: 16px; padding: 1.5rem; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card:hover { transform: translateY(-4px); box-shadow: 0 12px 25px -5px rgba(0, 0, 0, 0.1); border-color: var(--accent); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.25rem; }
        .card-title { font-size: 1.3rem; font-weight: 700; color: var(--primary); }
        .card-brand { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem; }
        
        .badges { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-top: auto; }
        .badge { padding: 0.25rem 0.6rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.05em; }
        .bg-iv { background: var(--success); } .bg-sc { background: var(--warning); color: #000; } .bg-po { background: var(--secondary); }
        .bg-ind { background: #e2e8f0; color: var(--primary); } .bg-class { background: var(--primary); }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.2s; padding: 1rem; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; width: 100%; max-width: 1200px; height: 95vh; border-radius: 16px; display: flex; flex-direction: column; transform: translateY(20px) scale(0.98); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-overlay.active .modal-content { transform: translateY(0) scale(1); }
        
        .modal-header { padding: 1.5rem 2rem; border-bottom: 1px solid var(--primary-border); display: flex; justify-content: space-between; align-items: flex-start; }
        .close-btn { background: #f1f5f9; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-dark); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .close-btn:hover { background: #e2e8f0; color: var(--danger); }
        .modal-body { padding: 0; overflow-y: auto; flex: 1; display: flex; flex-direction: column; }

        /* --- TABS --- */
        .tabs { display: flex; background: #f8fafc; border-bottom: 1px solid var(--primary-border); position: sticky; top: 0; z-index: 10; }
        .tab { flex: 1; text-align: center; padding: 1rem; cursor: pointer; font-weight: 600; font-size: 0.95rem; color: var(--text-muted); border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab:hover { color: var(--secondary); background: white; }
        .tab.active { color: var(--secondary); border-bottom-color: var(--secondary); background: white; }
        .tab-content { display: none; padding: 2rem; animation: fadeIn 0.2s ease-in; flex: 1;}
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- TYPOGRAPHY --- */
        h3 { color: var(--primary); margin: 1.5rem 0 0.75rem 0; font-size: 1.15rem; border-bottom: 2px solid var(--primary-light); padding-bottom: 0.4rem;}
        h3:first-child { margin-top: 0; }
        ul { margin-left: 1.5rem; margin-bottom: 1rem; color: var(--text-dark); }
        li { margin-bottom: 0.4rem; font-size: 0.95rem; }
        .highlight-text { font-weight: 600; color: var(--primary); }
        
        .alert-box { padding: 1rem 1.25rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.95rem; line-height: 1.5; background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; }
        .alert-box.warning { background: #fffbeb; border-color: #fde68a; color: #b45309; }
        .alert-box.danger { background: #fef2f2; border-color: #fecaca; color: #be123c; }

        /* --- ESCALATION CARDS --- */
        .escalation-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1rem; }
        @media(max-width: 768px) { .escalation-grid { grid-template-columns: 1fr; } }
        .esc-card { border-radius: 12px; border: 1px solid; overflow: hidden; }
        .esc-header { padding: 1rem 1.25rem; font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; }
        .esc-body { padding: 1.25rem; background: white; font-size: 0.95rem; }
        .esc-body p { margin-bottom: 0.5rem; }
        .esc-body ul { margin-bottom: 0; }
        
        .esc-pbs { border-color: #86efac; }
        .esc-pbs .esc-header { background: var(--success-light); color: #166534; }
        
        .esc-comp { border-color: #fcd34d; }
        .esc-comp .esc-header { background: var(--warning-light); color: #92400e; }

        /* --- PBS CONTROLS & TABLE --- */
        .pbs-controls-header { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; }
        .pill-group { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
        .pill-btn { padding: 0.5rem 1.25rem; border-radius: 99px; border: 1px solid var(--primary-border); background: white; font-size: 0.9rem; font-weight: 600; color: var(--text-muted); cursor: pointer; transition: all 0.2s; }
        .pill-btn:hover { border-color: var(--secondary); color: var(--secondary); }
        .pill-btn.active { background: var(--secondary); color: white; border-color: var(--secondary); box-shadow: 0 4px 6px -1px rgba(37,99,235,0.2); }
        .context-badge { margin-left: auto; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.8rem; font-weight: 700; background: var(--primary-light); color: var(--primary); border: 1px solid var(--primary-border); }

        .phase-explainer { background: white; border: 1px solid var(--primary-border); border-radius: 8px; overflow: hidden; margin-bottom: 1.5rem; }
        .phase-explainer-header { padding: 0.75rem 1rem; background: var(--primary-light); font-weight: 600; font-size: 0.9rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: var(--text-dark); }
        .phase-explainer-header:hover { background: #f1f5f9; }
        .phase-explainer-content { padding: 1rem; font-size: 0.85rem; display: none; border-top: 1px solid var(--primary-border); background: white; }
        .phase-explainer-content.active { display: block; }
        .phase-explainer-content ul { margin-left: 1rem; margin-bottom: 0; }
        
        .weight-calculator { background: var(--secondary-light); border: 1px solid #bfdbfe; padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;}
        .weight-input { width: 90px; padding: 0.5rem; border: 1px solid #93c5fd; border-radius: 6px; font-weight: bold; font-size: 1.1rem; text-align: center; outline: none; }
        .weight-input:focus { border-color: var(--secondary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }
        .weight-result { font-size: 1.05rem; color: var(--secondary); flex: 1; }

        .pbs-table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--primary-border); background: white; }
        .pbs-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; text-align: left; }
        .pbs-table th, .pbs-table td { border-bottom: 1px solid var(--primary-border); padding: 0.85rem 1rem; vertical-align: middle; }
        .pbs-table th { background-color: var(--primary-light); color: var(--primary); font-weight: 600; white-space: nowrap; }
        .pbs-table tr:last-child td { border-bottom: none; }
        .pbs-table tbody tr:hover { background-color: #f8fafc; }
        
        .auth-badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; white-space: nowrap; }
        .auth-streamlined { background: #ede9fe; color: #6d28d9; border: 1px solid #ddd6fe; }
        .auth-written { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .auth-phone { background: #ffedd5; color: #c2410c; border: 1px solid #fed7aa; }

        .code-pill {
            display: inline-flex; align-items: center; gap: 0.4rem; background: #f1f5f9; padding: 0.3rem 0.6rem; 
            border-radius: 6px; font-family: monospace; font-size: 0.95rem; font-weight: 700; color: var(--primary);
            cursor: pointer; border: 1px solid var(--primary-border); transition: all 0.2s;
        }
        .code-pill:hover { background: #e2e8f0; border-color: #cbd5e1; transform: translateY(-1px); }
        .code-pill::after { content: 'üìã'; font-size: 0.8rem; filter: grayscale(1); opacity: 0.6;}
        .code-copied { background: var(--success) !important; color: white !important; border-color: var(--success) !important; }
        .code-copied::after { content: '‚úì'; filter: none; opacity: 1;}

        .code-streamline { color: #6d28d9; background: #f5f3ff; border-color: #ede9fe; }
        .code-streamline:hover { background: #ede9fe; border-color: #ddd6fe; }

        .qty-badge { background: #f1f5f9; color: var(--primary); padding: 2px 8px; border-radius: 4px; font-weight: 700; border: 1px solid #e2e8f0; text-align: center; display: inline-block;}
        .rpt-badge { background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; font-weight: 700; border: 1px solid #bbf7d0; text-align: center; display: inline-block;}
    </style>
</head>
<body>

    <header>
        <h1>IBD Clinical & PBS Guide</h1>
        <p>Interactive prescribing tool with quick-filtering, weight-based calculators, escalation rules, and setting-specific Item codes.</p>
        
        <!-- Global Context Toggle -->
        <div class="context-toggle-wrapper">
            <div class="context-toggle">
                <button class="context-btn active" id="btn-context-public" onclick="setGlobalContext('public')">üè• Public Hospital (S100)</button>
                <button class="context-btn" id="btn-context-private" onclick="setGlobalContext('private')">üè¢ Private Hospital / Community</button>
            </div>
        </div>
    </header>

    <div class="main-controls">
        <input type="text" id="searchInput" class="form-control" placeholder="Search drug or brand (e.g. Stelara, Rinvoq)...">
        <select id="indicationFilter" class="form-control">
            <option value="all">All Indications</option>
            <option value="UC">Ulcerative Colitis (UC)</option>
            <option value="CD">Crohn's Disease (CD)</option>
            <option value="ASUC">Acute Severe UC (ASUC)</option>
            <option value="fCD">Fistulising CD (fCD)</option>
        </select>
        <select id="classFilter" class="form-control">
            <option value="all">All Classes</option>
            <option value="Anti-TNFŒ±">Anti-TNFŒ±</option>
            <option value="Anti-Integrin / IL">Anti-Integrin / Anti-Interleukin</option>
            <option value="JAK Inhibitor">JAK Inhibitors</option>
            <option value="S1P Agonist">S1P Agonists</option>
        </select>
    </div>

    <div class="container">
        <div class="grid" id="med-grid"></div>
    </div>

    <!-- Modal Base -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div>
                    <h2 id="modalTitle" style="color: var(--primary); font-size: 1.8rem; font-weight: 700; margin-bottom: 0.2rem;"></h2>
                    <div id="modalBrand" style="color: var(--text-muted); font-size: 1rem; font-style: italic;"></div>
                    <div id="modalBadges" class="badges" style="margin-top: 0.8rem;"></div>
                </div>
                <button class="close-btn" onclick="forceCloseModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab(this, 'tab-pbs')">PBS Criteria & Prescribing</div>
                    <div class="tab" onclick="switchTab(this, 'tab-dosing')">Dosing & Efficacy</div>
                    <div class="tab" onclick="switchTab(this, 'tab-escalation')">Dose Escalation</div>
                    <div class="tab" onclick="switchTab(this, 'tab-safety')">Safety & Precautions</div>
                </div>

                <div id="tab-pbs" class="tab-content active"><div id="pbs-dynamic-container"></div></div>
                <div id="tab-dosing" class="tab-content"></div>
                <div id="tab-escalation" class="tab-content"></div>
                <div id="tab-safety" class="tab-content"></div>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let currentSettingContext = 'public'; // 'public' or 'private'
        let currentMed = null;
        let currentSelectedIndication = 'all';

        // Update the global setting and re-render if modal is open
        function setGlobalContext(context) {
            currentSettingContext = context;
            document.getElementById('btn-context-public').classList.toggle('active', context === 'public');
            document.getElementById('btn-context-private').classList.toggle('active', context === 'private');
            
            // If modal is currently open, re-render the PBS table
            if (document.getElementById('modalOverlay').classList.contains('active') && currentMed) {
                renderTable();
            }
        }

        // --- DATABASE ---
        // Note the `context` attribute: "public", "private", or "both"
        const medications = [
            {
                name: "Ustekinumab",
                brand: "Stelara, Steqeyma",
                classGroup: "Anti-Integrin / IL",
                routes: ["IV", "SC"],
                indications: ["UC", "CD"],
                dosing: `
                    <h3>Standard Dosing Regimen</h3>
                    <ul>
                        <li><span class="highlight-text">IV Induction (Wk 0):</span> Weight-based single dose (260mg, 390mg, or 520mg).</li>
                        <li><span class="highlight-text">SC Maintenance:</span> 90 mg SC at Wk 8, then every 8 weeks.</li>
                    </ul>
                    <h3>Efficacy</h3>
                    <ul><li><span class="highlight-text">Onset:</span> ~7 weeks.</li><li><span class="highlight-text">Remission:</span> ~13 weeks.</li></ul>
                `,
                escalation: `
                    <div class="escalation-grid">
                        <div class="esc-card esc-pbs">
                            <div class="esc-header">‚úÖ PBS Allowed Escalation</div>
                            <div class="esc-body">
                                <ul>
                                    <li><strong>Shortening to q8w:</strong> If a patient was historically initiated on q12w dosing, stepping up to q8w is allowed and covered under standard PBS maintenance codes.</li>
                                </ul>
                            </div>
                        </div>
                        <div class="esc-card esc-comp">
                            <div class="esc-header">‚ö†Ô∏è Hospital / Compassionate Required</div>
                            <div class="esc-body">
                                <p>The following strategies are <strong>NOT funded</strong> by the PBS and require application to the Janssen compassionate program or hospital drug committees:</p>
                                <ul>
                                    <li><strong>Interval Shortening:</strong> Decreasing SC interval to 90mg every 4 weeks or 6 weeks.</li>
                                    <li><strong>IV Re-induction:</strong> Giving a second weight-based IV dose for secondary loss of response.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `,
                safety: `<div class="alert-box"><strong>Pregnancy Class B1:</strong> Likely safe.</div><ul><li>Infections, fatigue, injection site reactions.</li></ul>`,
                pbsRules: {
                    criteria: "Failed conventional therapy.",
                    hasWeightCalc: true,
                    calcType: "ustekinumab",
                    data: [
                        { ind: "UC", phase: "Initial (IV Load)", form: "130mg IV Vial", auth: "Written / PRODA", itemCode: "13272M", slCode: "-", qty: "Max 4", rpts: "0", context: "public" },
                        { ind: "UC", phase: "Initial (IV Load)", form: "130mg IV Vial", auth: "Written / PRODA", itemCode: "13255P", slCode: "-", qty: "Max 4", rpts: "0", context: "private" },
                        { ind: "UC", phase: "Balance (SC)", form: "90mg SC Syr", auth: "Telephone", itemCode: "13273N (Stelara)", slCode: "-", qty: "1", rpts: "0", context: "both" },
                        { ind: "UC", phase: "1st Cont. (SC)", form: "90mg SC Syr", auth: "Written / PRODA", itemCode: "13261Y (Stelara)", slCode: "-", qty: "1", rpts: "2", context: "both" },
                        { ind: "UC", phase: "Subs Cont.", form: "90mg SC Syr (Stelara)", auth: "STREAMLINED", itemCode: "13261Y", slCode: "16945", qty: "1", rpts: "2", context: "both" },
                        { ind: "UC", phase: "Subs Cont.", form: "90mg SC Syr (Steqeyma)", auth: "STREAMLINED", itemCode: "14918E", slCode: "16945", qty: "1", rpts: "2", context: "both" },
                        
                        { ind: "CD", phase: "Initial (IV Load)", form: "130mg IV Vial", auth: "Written / PRODA", itemCode: "11182M", slCode: "-", qty: "Max 4", rpts: "0", context: "public" },
                        { ind: "CD", phase: "Initial (IV Load)", form: "130mg IV Vial", auth: "Written / PRODA", itemCode: "11164N", slCode: "-", qty: "Max 4", rpts: "0", context: "private" },
                        { ind: "CD", phase: "Balance (SC)", form: "90mg SC (1x 90mg)", auth: "Telephone", itemCode: "14934B (Stelara)", slCode: "-", qty: "1", rpts: "0", context: "both" },
                        { ind: "CD", phase: "Balance (SC)", form: "90mg SC (as 2x 45mg)", auth: "Telephone", itemCode: "11178H (Stelara)", slCode: "-", qty: "2", rpts: "0", context: "both" },
                        { ind: "CD", phase: "1st Cont.", form: "90mg SC (as 2x 45mg)", auth: "Written / PRODA", itemCode: "11178H (Stelara)", slCode: "-", qty: "2", rpts: "1", context: "both" },
                        { ind: "CD", phase: "Subs Cont.", form: "90mg SC Syr (Stelara)", auth: "STREAMLINED", itemCode: "14926N", slCode: "16909", qty: "1", rpts: "1", context: "both" },
                        { ind: "CD", phase: "Subs Cont.", form: "90mg SC (as 2x 45mg) (Steqeyma)", auth: "STREAMLINED", itemCode: "14909Q", slCode: "16913", qty: "2", rpts: "1", context: "both" }
                    ]
                }
            },
            {
                name: "Adalimumab",
                brand: "Humira, Amgevita, Hadlima, Hyrimoz, Yuflyma, Abrilada",
                classGroup: "Anti-TNFŒ±",
                routes: ["SC"],
                indications: ["UC", "CD", "fCD"],
                dosing: `
                    <h3>Standard Dosing Regimen</h3>
                    <ul><li><span class="highlight-text">Induction:</span> 160 mg SC Wk 0, 80 mg SC Wk 2.</li><li><span class="highlight-text">Maintenance:</span> 40 mg SC every 2 weeks.</li></ul>
                `,
                escalation: `
                    <div class="escalation-grid">
                        <div class="esc-card esc-pbs">
                            <div class="esc-header">‚úÖ PBS Allowed Escalation</div>
                            <div class="esc-body">
                                <p>Dose escalation is fully supported on the PBS for patients who experience secondary loss of response to standard maintenance.</p>
                                <ul>
                                    <li><strong>Interval Shortening:</strong> 40 mg SC weekly (prescribe Qty 4 per 28 days).</li>
                                    <li><strong>Dose Doubling:</strong> 80 mg SC every 2 weeks (using 80mg pens, prescribe Qty 2 per 28 days).</li>
                                </ul>
                                <p style="margin-top:0.5rem; font-size:0.85rem; color:var(--text-muted);"><em>Note: Requires a new Authority application demonstrating the loss of response.</em></p>
                            </div>
                        </div>
                    </div>
                `,
                safety: `<div class="alert-box"><strong>Pregnancy Class B2:</strong> Low risk.</div>`,
                pbsRules: {
                    criteria: "Failed conventional therapy. Must meet severity criteria.",
                    hasWeightCalc: false,
                    data: [
                        { ind: "UC", phase: "Initial (Load 160mg)", form: "40mg Syr/Pen", auth: "Written / PRODA", itemCode: "12333D, 12382Q", slCode: "-", qty: "6", rpts: "0", context: "both" },
                        { ind: "UC", phase: "Initial (Load 160mg)", form: "80mg Syr/Pen", auth: "Written / PRODA", itemCode: "12339K, 12374G", slCode: "-", qty: "3", rpts: "0", context: "both" },
                        { ind: "UC", phase: "Balance", form: "40mg Syr/Pen", auth: "Telephone", itemCode: "10944B, 12359L", slCode: "-", qty: "2", rpts: "2", context: "both" },
                        { ind: "UC", phase: "1st Cont.", form: "40mg Syr/Pen", auth: "Written / PRODA", itemCode: "10960W, 12391E", slCode: "-", qty: "2", rpts: "5", context: "both" },
                        { ind: "UC", phase: "Subs Cont.", form: "40mg (Humira)", auth: "STREAMLINED", itemCode: "12325Q", slCode: "16991", qty: "2", rpts: "5", context: "both" },
                        
                        { ind: "CD", phase: "Initial (Load 160mg)", form: "40mg Syr/Pen", auth: "Written / PRODA", itemCode: "12387Y, 12453K", slCode: "-", qty: "6", rpts: "0", context: "both" },
                        { ind: "CD", phase: "Initial (Load 160mg)", form: "80mg Syr/Pen", auth: "Written / PRODA", itemCode: "12372E, 12419P", slCode: "-", qty: "3", rpts: "0", context: "both" },
                        { ind: "CD", phase: "Balance", form: "40mg Syr/Pen", auth: "Telephone", itemCode: "9188N, 12451H", slCode: "-", qty: "2", rpts: "2", context: "both" },
                        { ind: "CD", phase: "1st Cont.", form: "40mg Syr/Pen", auth: "Written / PRODA", itemCode: "9189P, 12410E", slCode: "-", qty: "2", rpts: "5", context: "both" },
                        { ind: "CD", phase: "Subs Cont.", form: "40mg (Amgevita)", auth: "STREAMLINED", itemCode: "12437N", slCode: "11631", qty: "2", rpts: "5", context: "both" },
                        
                        { ind: "fCD", phase: "Initial (Load 160mg)", form: "40mg Syr/Pen", auth: "Written / PRODA", itemCode: "12387Y", slCode: "-", qty: "6", rpts: "0", context: "both" },
                        { ind: "fCD", phase: "Continuing", form: "40mg Syr/Pen", auth: "Telephone", itemCode: "8964T", slCode: "-", qty: "2", rpts: "5", context: "both" }
                    ]
                }
            },
            {
                name: "Infliximab",
                brand: "Remicade, Remsima, Inflectra",
                classGroup: "Anti-TNFŒ±",
                routes: ["IV", "SC"],
                indications: ["ASUC", "UC", "CD", "fCD"],
                dosing: `
                    <h3>Standard Dosing Regimen</h3>
                    <ul><li><span class="highlight-text">IV Induction:</span> 5 mg/kg IV at Weeks 0, 2, and 6.</li><li><span class="highlight-text">SC Maintenance:</span> 120 mg SC every 2 weeks.</li></ul>
                `,
                escalation: `
                    <div class="escalation-grid">
                        <div class="esc-card esc-pbs">
                            <div class="esc-header">‚úÖ PBS Allowed Escalation</div>
                            <div class="esc-body">
                                <ul>
                                    <li><strong>IV Escalation:</strong> Shortening the IV interval (e.g., to q6w or q4w) OR doubling the dose (10mg/kg q8w) is technically allowed on the PBS <strong>ONLY IF</strong> the total dose does not exceed the maximum allowable vials per script (usually 5 vials = 500mg).</li>
                                    <li><em>Example:</em> A 50kg patient getting 10mg/kg needs 5 vials (Covered). A 75kg patient needs 8 vials (Requires hospital funding).</li>
                                </ul>
                            </div>
                        </div>
                        <div class="esc-card esc-comp">
                            <div class="esc-header">‚ö†Ô∏è Hospital / Compassionate Required</div>
                            <div class="esc-body">
                                <ul>
                                    <li><strong>High Dose IV:</strong> Any dose requiring >5 vials per infusion requires hospital drug committee funding or compassionate supply.</li>
                                    <li><strong>Subcut Escalation:</strong> Increasing SC frequency to 120mg <strong>weekly</strong> is NOT PBS listed and requires compassionate access (e.g. via Celltrion).</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `,
                safety: `<div class="alert-box"><strong>Pregnancy Class B2:</strong> Low risk.</div>`,
                pbsRules: {
                    criteria: "Failed conventional therapy.",
                    hasWeightCalc: true,
                    calcType: "infliximab",
                    data: [
                        { ind: "ASUC", phase: "Initial (Rescue)", form: "100mg IV Vial", auth: "Written / PRODA", itemCode: "10067W", slCode: "-", qty: "X*", rpts: "1", context: "public" },
                        { ind: "ASUC", phase: "Initial (Rescue)", form: "100mg IV Vial", auth: "Written / PRODA", itemCode: "10057H", slCode: "-", qty: "X*", rpts: "1", context: "private" },
                        
                        { ind: "UC", phase: "Initial (IV Load)", form: "100mg IV Vial", auth: "Written / PRODA", itemCode: "10196P", slCode: "-", qty: "X*", rpts: "2", context: "public" },
                        { ind: "UC", phase: "Initial (IV Load)", form: "100mg IV Vial", auth: "Written / PRODA", itemCode: "10184B", slCode: "-", qty: "X*", rpts: "2", context: "private" },
                        { ind: "UC", phase: "Continuing (IV)", form: "100mg IV Vial", auth: "Telephone", itemCode: "11459D", slCode: "-", qty: "X*", rpts: "2", context: "public" },
                        { ind: "UC", phase: "Continuing (IV)", form: "100mg IV Vial", auth: "Telephone", itemCode: "11797X", slCode: "-", qty: "X*", rpts: "2", context: "private" },
                        { ind: "UC", phase: "Switch to SC", form: "120mg SC (Remsima)", auth: "STREAMLINED", itemCode: "12586K", slCode: "17432", qty: "2", rpts: "5", context: "both" },
                        { ind: "UC", phase: "Continuing (SC)", form: "120mg SC (Remsima)", auth: "Telephone", itemCode: "12561D", slCode: "-", qty: "2", rpts: "2", context: "both" },

                        { ind: "CD", phase: "Initial (IV Load)", form: "100mg IV Vial", auth: "Written / PRODA", itemCode: "9654D", slCode: "-", qty: "X*", rpts: "2", context: "public" },
                        { ind: "CD", phase: "Initial (IV Load)", form: "100mg IV Vial", auth: "Written / PRODA", itemCode: "9674E", slCode: "-", qty: "X*", rpts: "2", context: "private" },
                        { ind: "CD", phase: "Continuing (IV)", form: "100mg IV Vial", auth: "Telephone", itemCode: "11424G", slCode: "-", qty: "X*", rpts: "2", context: "public" },
                        { ind: "CD", phase: "Continuing (IV)", form: "100mg IV Vial", auth: "Telephone", itemCode: "11412P", slCode: "-", qty: "X*", rpts: "2", context: "private" },
                        { ind: "CD", phase: "Switch to SC", form: "120mg SC (Remsima)", auth: "STREAMLINED", itemCode: "13073C", slCode: "17533", qty: "2", rpts: "5", context: "both" },
                        { ind: "CD", phase: "Continuing (SC)", form: "120mg SC (Remsima)", auth: "Telephone", itemCode: "12585J", slCode: "-", qty: "2", rpts: "2", context: "both" },
                        
                        { ind: "fCD", phase: "Continuing (SC)", form: "120mg SC (Remsima)", auth: "Telephone", itemCode: "13072B", slCode: "-", qty: "2", rpts: "2", context: "both" }
                    ]
                }
            },
            {
                name: "Vedolizumab",
                brand: "Entyvio",
                classGroup: "Anti-Integrin / IL",
                routes: ["IV", "SC"],
                indications: ["UC", "CD"],
                dosing: `<ul><li><span class="highlight-text">IV Induction:</span> 300 mg IV at Weeks 0, 2, and 6.</li><li><span class="highlight-text">SC Maintenance:</span> 108 mg SC every 2 weeks.</li></ul>`,
                escalation: `
                    <div class="escalation-grid">
                        <div class="esc-card esc-pbs">
                            <div class="esc-header">‚úÖ PBS Allowed Escalation</div>
                            <div class="esc-body">
                                <ul>
                                    <li><strong>IV Interval Shortening:</strong> Increasing IV frequency to 300mg <strong>every 4 weeks</strong> is allowed on the PBS for patients who lose response to standard 8-weekly dosing.</li>
                                    <li><em>Note:</em> Requires a new Authority demonstrating secondary loss of response.</li>
                                </ul>
                            </div>
                        </div>
                        <div class="esc-card esc-comp">
                            <div class="esc-header">‚ö†Ô∏è Hospital / Compassionate Required</div>
                            <div class="esc-body">
                                <ul>
                                    <li><strong>Subcut Escalation:</strong> Increasing the SC frequency to 108mg <strong>weekly</strong> is NOT listed on the PBS. It requires compassionate access or switching the patient back to IV q4w.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `,
                safety: `<div class="alert-box"><strong>Pregnancy Class B2:</strong> Low risk. Gut selective.</div>`,
                pbsRules: {
                    criteria: "Failed conventional therapy.",
                    hasWeightCalc: false,
                    data: [
                        { ind: "UC", phase: "Initial (IV Load)", form: "300mg IV Vial", auth: "Written / PRODA", itemCode: "10384M", slCode: "-", qty: "1", rpts: "2", context: "public" },
                        { ind: "UC", phase: "Initial (IV Load)", form: "300mg IV Vial", auth: "Written / PRODA", itemCode: "10398G", slCode: "-", qty: "1", rpts: "2", context: "private" },
                        { ind: "UC", phase: "Switch to SC", form: "108mg SC Pen", auth: "Written / PRODA", itemCode: "12644L", slCode: "-", qty: "2", rpts: "0", context: "both" },
                        { ind: "UC", phase: "Continuing (SC)", form: "108mg SC Pen", auth: "Telephone", itemCode: "12639F", slCode: "-", qty: "2", rpts: "5", context: "both" },
                        
                        { ind: "CD", phase: "Initial (IV Load)", form: "300mg IV Vial", auth: "Written / PRODA", itemCode: "10390W", slCode: "-", qty: "1", rpts: "2", context: "public" },
                        { ind: "CD", phase: "Initial (IV Load)", form: "300mg IV Vial", auth: "Written / PRODA", itemCode: "10415E", slCode: "-", qty: "1", rpts: "2", context: "private" },
                        { ind: "CD", phase: "Switch to SC", form: "108mg SC Pen", auth: "Written / PRODA", itemCode: "12638E", slCode: "-", qty: "2", rpts: "0", context: "both" },
                        { ind: "CD", phase: "Continuing (SC)", form: "108mg SC Pen", auth: "Telephone", itemCode: "12654B", slCode: "-", qty: "2", rpts: "5", context: "both" }
                    ]
                }
            },
            {
                name: "Upadacitinib",
                brand: "Rinvoq",
                classGroup: "JAK Inhibitor",
                routes: ["PO"],
                indications: ["UC", "CD"],
                dosing: `<ul><li><span class="highlight-text">Induction:</span> 45 mg daily for 8-16 weeks.</li><li><span class="highlight-text">Maintenance:</span> 15 mg or 30 mg daily.</li></ul>`,
                escalation: `
                    <div class="escalation-grid">
                        <div class="esc-card esc-pbs">
                            <div class="esc-header">‚úÖ PBS Allowed Escalation</div>
                            <div class="esc-body">
                                <ul>
                                    <li><strong>Induction Extension:</strong> The 45mg induction phase can be extended for an extra 8 weeks (Total 16 wks for UC, up to 24 wks for CD) if initial response is delayed.</li>
                                    <li><strong>Maintenance Step-Up:</strong> If a patient loses response on 15mg daily, stepping up to <strong>30mg daily</strong> is fully supported on the PBS.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `,
                safety: `<div class="alert-box danger"><strong>Pregnancy Class D:</strong> Strictly Contraindicated.</div><ul><li><strong style="color:var(--danger)">Shingles:</strong> 14x increased risk. Shingrix mandatory.</li></ul>`,
                pbsRules: {
                    criteria: "UC: Failed conventional AND 1 prior biologic. CD: Failed conventional AND 2 prior biologics.",
                    hasWeightCalc: false,
                    data: [
                        { ind: "UC", phase: "Initial", form: "45mg Tabs", auth: "Written / PRODA", itemCode: "13262B", slCode: "-", qty: "28", rpts: "3", context: "both" },
                        { ind: "UC", phase: "1st Cont.", form: "15mg Tabs", auth: "Written / PRODA", itemCode: "13250J", slCode: "-", qty: "28", rpts: "5", context: "both" },
                        { ind: "UC", phase: "Subs Cont.", form: "15mg Tabs", auth: "STREAMLINED", itemCode: "13256Q", slCode: "16991", qty: "28", rpts: "5", context: "both" },
                        { ind: "UC", phase: "Subs Cont.", form: "30mg Tabs", auth: "STREAMLINED", itemCode: "13265E", slCode: "16991", qty: "28", rpts: "5", context: "both" },
                        
                        { ind: "CD", phase: "Initial", form: "45mg Tabs", auth: "Written / PRODA", itemCode: "13771T", slCode: "-", qty: "28", rpts: "2", context: "both" },
                        { ind: "CD", phase: "1st Cont.", form: "15mg Tabs", auth: "Written / PRODA", itemCode: "13768P", slCode: "-", qty: "28", rpts: "5", context: "both" },
                        { ind: "CD", phase: "Subs Cont.", form: "30mg Tabs", auth: "STREAMLINED", itemCode: "13746L", slCode: "11631", qty: "28", rpts: "5", context: "both" }
                    ]
                }
            },
            {
                name: "Tofacitinib",
                brand: "Xeljanz",
                classGroup: "JAK Inhibitor",
                routes: ["PO"],
                indications: ["UC"],
                dosing: `<ul><li><span class="highlight-text">Induction:</span> 10 mg BD.</li><li><span class="highlight-text">Maintenance:</span> 5 mg BD.</li></ul>`,
                escalation: `
                    <div class="escalation-grid">
                        <div class="esc-card esc-pbs">
                            <div class="esc-header">‚úÖ PBS Allowed Escalation</div>
                            <div class="esc-body">
                                <ul>
                                    <li><strong>Maintenance Step-Up:</strong> If a patient loses response on 5mg BD, maintaining them long-term on <strong>10mg BD</strong> is PBS allowed (though carries higher VTE/Shingles risk).</li>
                                </ul>
                            </div>
                        </div>
                        <div class="esc-card esc-comp">
                            <div class="esc-header">‚ö†Ô∏è Hospital / Off-Label</div>
                            <div class="esc-body">
                                <ul>
                                    <li><strong>ASUC Rescue:</strong> Using 10mg TDS (three times daily) for a few days in Acute Severe UC is an off-label hospital protocol and is not standard PBS prescribing.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `,
                safety: `<div class="alert-box danger"><strong>Pregnancy Class D:</strong> Strictly Contraindicated.</div>`,
                pbsRules: {
                    criteria: "Failed conventional therapy AND failed/intolerant to anti-TNFŒ± OR vedolizumab.",
                    hasWeightCalc: false,
                    data: [
                        { ind: "UC", phase: "Initial", form: "10mg Tabs", auth: "Written / PRODA", itemCode: "12588M", slCode: "-", qty: "56", rpts: "3", context: "both" },
                        { ind: "UC", phase: "Continuing (Balance/Subs)", form: "10mg Tabs", auth: "Telephone", itemCode: "12589N", slCode: "-", qty: "56", rpts: "5", context: "both" },
                        { ind: "UC", phase: "Initial", form: "5mg Tabs", auth: "Written / PRODA", itemCode: "12556W", slCode: "-", qty: "56", rpts: "3", context: "both" },
                        { ind: "UC", phase: "Continuing (Balance/Subs)", form: "5mg Tabs", auth: "Telephone", itemCode: "12557X", slCode: "-", qty: "56", rpts: "5", context: "both" }
                    ]
                }
            }
        ];

        // --- RENDER LOGIC ---
        const grid = document.getElementById('med-grid');
        const searchInput = document.getElementById('searchInput');
        const classFilter = document.getElementById('classFilter');
        const indFilter = document.getElementById('indicationFilter');

        function renderCards() {
            const search = searchInput.value.toLowerCase();
            const filterClass = classFilter.value;
            const filterInd = indFilter.value;

            grid.innerHTML = '';
            const filtered = medications.filter(m => {
                const matchSearch = m.name.toLowerCase().includes(search) || m.brand.toLowerCase().includes(search);
                const matchClass = filterClass === 'all' || m.classGroup === filterClass;
                const matchInd = filterInd === 'all' || m.indications.includes(filterInd);
                return matchSearch && matchClass && matchInd;
            });

            filtered.forEach((med) => {
                const routesHtml = med.routes.map(r => `<span class="badge bg-${r.toLowerCase()}">${r}</span>`).join('');
                const indHtml = med.indications.map(i => `<span class="badge bg-ind">${i}</span>`).join('');
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-header"><h2 class="card-title">${med.name}</h2></div>
                    <div class="card-brand">${med.brand}</div>
                    <div class="card-class">${med.classGroup}</div>
                    <div class="badges">${routesHtml}${indHtml}</div>
                `;
                card.onclick = () => openModal(med);
                grid.appendChild(card);
            });
        }

        searchInput.addEventListener('input', renderCards);
        classFilter.addEventListener('change', renderCards);
        indFilter.addEventListener('change', renderCards);

        // --- MODAL & DYNAMIC PBS ENGINE ---
        const modalOverlay = document.getElementById('modalOverlay');
        const tabDosing = document.getElementById('tab-dosing');
        const tabEscalation = document.getElementById('tab-escalation');
        const tabSafety = document.getElementById('tab-safety');

        function openModal(med) {
            currentMed = med;
            document.getElementById('modalTitle').textContent = med.name;
            document.getElementById('modalBrand').textContent = med.brand;
            
            const routesHtml = med.routes.map(r => `<span class="badge bg-${r.toLowerCase()}">${r}</span>`).join('');
            const indHtml = med.indications.map(i => `<span class="badge bg-ind">${i}</span>`).join('');
            document.getElementById('modalBadges').innerHTML = routesHtml + indHtml + `<span class="badge bg-class">${med.classGroup}</span>`;

            tabDosing.innerHTML = med.dosing;
            tabEscalation.innerHTML = med.escalation || '<p style="color:var(--text-muted); font-style:italic;">No dose escalation pathways currently recommended or funded for this agent.</p>';
            tabSafety.innerHTML = med.safety;
            
            currentSelectedIndication = med.indications.length > 0 ? med.indications[0] : 'all';
            buildPBSUI(med);

            document.querySelectorAll('.tab').forEach((t, i) => { i === 0 ? t.classList.add('active') : t.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach((tc, i) => { i === 0 ? tc.classList.add('active') : tc.classList.remove('active'); });

            modalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(e) { if (e.target === modalOverlay) forceCloseModal(); }
        function forceCloseModal() { modalOverlay.classList.remove('active'); document.body.style.overflow = 'auto'; }

        function switchTab(clickedTab, targetId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            clickedTab.classList.add('active');
            document.getElementById(targetId).classList.add('active');
        }

        // --- PBS ENGINE LOGIC ---
        function buildPBSUI(med) {
            const container = document.getElementById('pbs-dynamic-container');
            container.innerHTML = '';
            if (!med.pbsRules) return;

            let html = `<div class="alert-box"><strong>PBS Criteria:</strong> ${med.pbsRules.criteria}</div>`;

            if (med.pbsRules.hasWeightCalc) {
                html += `
                    <div class="weight-calculator">
                        <div>
                            <div style="font-size: 0.8rem; font-weight: 700; color: var(--primary); text-transform: uppercase; margin-bottom: 0.2rem;">Patient Weight</div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="number" class="weight-input" id="calcWeight" placeholder="e.g. 75"> <span>kg</span>
                            </div>
                        </div>
                        <div class="weight-result" id="calcOutput">Enter weight to calculate precise induction dose.</div>
                    </div>
                `;
            }

            const availableInds = [...new Set(med.pbsRules.data.map(d => d.ind))];
            let pillsHtml = availableInds.map(i => `<button class="pill-btn ${i === currentSelectedIndication ? 'active' : ''}" onclick="setIndication('${i}')">${i}</button>`).join('');

            let contextText = currentSettingContext === 'public' ? 'üè• Public Hospital' : 'üè¢ Private Hospital / Community';

            html += `
                <div class="pbs-controls-header">
                    <div class="pill-group" id="ind-pills">
                        ${pillsHtml}
                        <div class="context-badge">Filter applied: ${contextText}</div>
                    </div>
                    <div class="phase-explainer">
                        <div class="phase-explainer-header" onclick="toggleExplainer()">
                            <span>üí° What do the PBS Phases mean?</span><span id="explainer-icon">‚ñº</span>
                        </div>
                        <div class="phase-explainer-content" id="explainer-content">
                            <ul>
                                <li><strong>Initial (Induction):</strong> First ever script. Requires baseline clinical scores via Written/PRODA Authority.</li>
                                <li><strong>Balance of Supply:</strong> Completes the induction period before evaluating maintenance. Usually a Telephone Authority.</li>
                                <li><strong>1st Continuing:</strong> First maintenance script. Requires demonstrating clinical response via Written/PRODA.</li>
                                <li><strong>Subsequent Continuing:</strong> Ongoing maintenance. For many biosimilars, this is a <strong>STREAMLINED</strong> authority. Put both the Item Code and Streamlined Code on the script.</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="pbs-table-wrapper">
                    <table class="pbs-table">
                        <thead><tr><th>Phase</th><th>Formulation</th><th>Authority Type</th><th>Item Code</th><th>Streamlined Code</th><th>Qty</th><th>Rpts</th></tr></thead>
                        <tbody id="pbsTableBody"></tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            if (med.pbsRules.hasWeightCalc) {
                document.getElementById('calcWeight').addEventListener('input', (e) => calculateDose(e.target.value, med.pbsRules.calcType));
            }
            renderTable();
        }

        function toggleExplainer() {
            const content = document.getElementById('explainer-content');
            const icon = document.getElementById('explainer-icon');
            content.classList.toggle('active');
            icon.textContent = content.classList.contains('active') ? '‚ñ≤' : '‚ñº';
        }

        function setIndication(ind) {
            currentSelectedIndication = ind;
            document.querySelectorAll('#ind-pills .pill-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === ind);
            });
            renderTable();
        }

        function calculateDose(weight, type) {
            const out = document.getElementById('calcOutput');
            if (!weight || weight <= 0) { out.textContent = "Enter weight to calculate induction dose."; return; }
            if (type === 'infliximab') {
                let dose = weight * 5; let vials = Math.ceil(dose / 100);
                out.innerHTML = `Dose: <strong>${dose} mg</strong> &rarr; Prescribe <strong>${vials} x 100mg vials</strong>.`;
            } else if (type === 'ustekinumab') {
                let dose = weight <= 55 ? 260 : weight <= 85 ? 390 : 520;
                let vials = weight <= 55 ? 2 : weight <= 85 ? 3 : 4;
                out.innerHTML = `Dose: <strong>${dose} mg</strong> &rarr; Prescribe <strong>${vials} x 130mg vials</strong>.`;
            }
        }

        function renderTable() {
            const tbody = document.getElementById('pbsTableBody');
            
            // Filter by Indication AND Global Context (Public vs Private)
            const filtered = currentMed.pbsRules.data.filter(d => 
                (d.ind === currentSelectedIndication) && 
                (d.context === 'both' || d.context === currentSettingContext)
            );

            if(filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:var(--text-muted); padding:2rem;">No matching PBS codes found for this setting.</td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map(d => {
                let authClass = 'auth-written';
                if(d.auth.includes('Telephone')) authClass = 'auth-phone';
                if(d.auth.includes('STREAMLINED')) authClass = 'auth-streamlined';

                let itemHtml = d.itemCode.split(', ').map(c => {
                    let clean = c.split(' ')[0];
                    return `<span class="code-pill" onclick="copyCode(this, '${clean}')" title="Copy Item Code">${c}</span>`;
                }).join('<br>');

                let slHtml = d.slCode === '-' ? '<span style="color:var(--text-muted)">N/A</span>' : 
                    `<span class="code-pill code-streamline" onclick="copyCode(this, '${d.slCode}')" title="Copy Streamline Code">${d.slCode}</span>`;

                return `
                <tr>
                    <td><strong>${d.phase}</strong></td>
                    <td>${d.form}</td>
                    <td><span class="auth-badge ${authClass}">${d.auth}</span></td>
                    <td>${itemHtml}</td>
                    <td>${slHtml}</td>
                    <td style="text-align:center"><span class="qty-badge">${d.qty}</span></td>
                    <td style="text-align:center"><span class="rpt-badge">${d.rpts}</span></td>
                </tr>
            `}).join('');
        }

        function copyCode(element, text) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = element.innerHTML;
                element.innerText = "Copied!";
                element.classList.add('code-copied');
                setTimeout(() => {
                    element.innerHTML = originalText;
                    element.classList.remove('code-copied');
                }, 1000);
            });
        }

        renderCards();
    </script>
</body>
</html>